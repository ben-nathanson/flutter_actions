# Name of your workflow.
name: flutter drive

# Trigger the workflow on push or pull request.
on: [push, pull_request]

env:
  flutter_version: "1.17.4"

jobs:
  drive:
    strategy:
      matrix:
        device:
        - "iPhone 8 (13.5)" # TODO find a way to handle iOS version changes (e.g. 13.1->13.5)
      fail-fast: true
    timeout-minutes: 20 # Fail after 20 minutes.
    runs-on: macOS-latest

    steps:
    - name: "List all simulators"
      run: "xcrun instruments -s"

    - name: "Start Simulator"
      run: |
        UDID=$(
          xcrun instruments -s |
          awk \
            -F ' *[][]' \
            -v 'device=${{ matrix.device }}' \
            '$1 == device { print $2 }'
        )
        xcrun simctl boot "${UDID:?No Simulator with this name found}"
    
    - name: Checkout
      uses: actions/checkout@28c7f3d2b5162b5ddd3dfd9a45aa55eaf396478b
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v1
      with:
        flutter-version: ${{ env.flutter_version }}

    - name: "Print flutter path"
      run: |
        echo FLUTTER_HOME: $FLUTTER_HOME

    - name: "Confirm the contents of the Flutter directory"
      run: |
        ls $FLUTTER_HOME

    - name: Cache Flutter dependencies
      uses: actions/cache@v2
      with:
        path: /opt/hostedtoolcache/flutter
        key: ${{ runner.OS }}-flutter-install-cache-${{ env.flutter_version }}

    - name: Install dependencies
      run: flutter pub get

    - name: Run Flutter Driver tests
      run: "flutter drive --target=test_driver/app.dart" 
